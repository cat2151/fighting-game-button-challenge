# issues
https://github.com/cat2151/fighting-game-button-challenge/issues/5

# tomlに左右どちらも記述するのは、tomlメンテコストが高い #5
# 対策案
- 左右ランダム、tomlの簡素化
    - button_challenge.toml に「左」or「右」で記載されているものは、ひとまず「右」で記載し、「左」を削除
    - button_challenge.toml left_right = ['左', '右']
    - play中は、left_right を使って、ランダム50%で左右反転
    - （alias実装後）左右のかわりに前後や123456789を記載可能に

# LLMに対策案を書かせる
- プロンプト「どうやって実装するか可視化して、開発者の認知負荷を下げてください。具体的には、修正対象ソース、関数、pythonの実際の追加codeや変更code を、このmdに追記してください。このプロンプトと、ここから上は、維持してください。」

# ---

## 修正対象ソース・関数

- [`missions.py`](../missions.py)
  - ミッション表示時に左右反転をランダムで行う処理を追加
  - 反転用の関数を新規追加
- [`configs.py`](../configs.py)
  - `left_right`・`left_right_temp`の値をtomlから読み込む
- [`main.py`](../main.py)
  - ミッション表示前に反転処理を挟む
- [`button_challenge.toml`](../button_challenge.toml)
  - ミッションは「右」だけ記載し、「左」は削除（既に案通りになっている）

---

## 追加・変更するPythonコード例

### 1. [`configs.py`](../configs.py)
`load_game_configuration`で`left_right`と`left_right_temp`も返すように修正

```python
# ...existing code...
def load_game_configuration():
    args = get_args()
    args = update_args_by_toml(args, args.config_filename)
    (names, plus, lever_names, missions) = load_all_configs(args)
    config = read_toml(args.config_filename)
    left_right = config.get("left_right", ["左", "右"])
    left_right_temp = config.get("left_right_temp", ["ひだり", "みぎ"])
    return args, names, plus, lever_names, missions, left_right, left_right_temp
# ...existing code...
```

### 2. [`missions.py`](../missions.py)
ミッション文字列を左右ランダムで反転する関数を追加

```python
import random
# ...existing code...

def maybe_reverse_left_right(mission, left_right, left_right_temp):
    # 50%の確率で左右反転
    if random.random() < 0.5:
        return mission
    # 一時的に置換
    mission_tmp = mission
    for orig, temp in zip(left_right, left_right_temp):
        mission_tmp = mission_tmp.replace(orig, temp)
    # 左右入れ替え
    for orig, temp in zip(left_right, reversed(left_right_temp)):
        mission_tmp = mission_tmp.replace(temp, orig)
    return mission_tmp

# ...existing code...
```

### 3. [`main.py`](../main.py)
`main`や`main_loop`でミッション表示前に反転処理を挟む

```python
# ...existing code...
from missions import check_and_update_mission, initialize_mission_sets, maybe_reverse_left_right
# ...existing code...
def main():
    (args, names, plus, lever_names, missions, left_right, left_right_temp) = load_game_configuration()
    # ...existing code...
    main_loop(tkinter_root, args, check_interval_msec, last_check_msec, joystick, names, plus, lever_names, missions, mission_index, missions_set, success_missions, labels, timer_id_dict, clock, left_right, left_right_temp)
# ...existing code...
def main_loop(..., left_right, left_right_temp):
    # ...existing code...
    while True:
        # ...existing code...
        (mission, mission_index, missions_set, success_missions, score) = check_and_update_mission(...)
        # ここで左右ランダム反転
        mission_display = maybe_reverse_left_right(mission, left_right, left_right_temp)
        old_texts = update_display_with_mission(..., mission_display)
        # ...existing code...
# ...existing code...
```

---

このように修正すれば、tomlの記述を「右」だけにしつつ、実行時に50%で左右反転表示が可能です。
この案を`issue-notes/5.md`の下部に追記します。

---

# レビュー結果
- 手早くレビューしました。
  - まず、5.mdに追記されたものはsourceへのlink形式になっておらず手で開く羽目になり不便でした。linkがほしい。
    - → プロンプト「5.mdを整形してください。具体的には、sourceのlinkは、すべてmarkdown linkの形式にしてください。」で対処しました。
    - → LLMが生成をミスってたので、さらに修正させました。
    - → link踏んでみたもののわかりづらい。普通にagentに直接code修正させるいつものやり方のほうが速い。
  - 次に、maybe～を書く場所が不適切に思えます。
    - そこではview層が変更されるだけに見えます。
    - そうではなく、check_and_update_mission にてmissionを取得後にmaybe～を適用するのでは？
  - → これをLLMに食わせたら破綻したので中断
- 実際は、先頭で「なおして」とagentに書いて直接なおさせるほうが速い認識。今回はあくまで実験として残した。
- まとめ
  - #5 に限った話で、
    - この手法は、現在のLLM性能では失敗した。
        - 普通にagentに直接codeなおさせるほうが速そう。
    - 今後も、LLMに可視化させ、開発者の認知負荷を下げる観点で進める実験は継続するとして、
      - 次は、もっとシンプルで小さい一歩を試そう。

# Blueskyに投稿してから気づいた
- 左右反転のタイミング、まだおかしいんじゃね
- そもそもindexでmissionを指定してるやつで、毎フレmissionをgetしてるんだとしたら、反転が毎フレになったらヤバくね
- まず今やってるmission string自体は、一度mission get時に左右反転したあとは、固定、という構造にリファクタリングが先じゃね
- sourceうろ覚えだけどそんな気がする
- 詳しくはあとで見よう
