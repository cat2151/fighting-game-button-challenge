# issue #8 「弱 + 中」mission成功直後に「弱」missionが出たとき、中ボタンを離しただけでクリアになり混乱する #8
[issues #8](https://github.com/cat2151/fighting-game-button-challenge/issues/8)

# なにが問題？
- playerが混乱する
- 練習不足になる。この例だと「弱」missionの練習になってない

# 案
- ボタンを離すまで次の入力を受け付けない
- 実現方法は、シンプルにやるつもり

# LLMに可視化させる、認知負荷を下げる
- プロンプト「外部仕様の案、内部仕様の案、変更のある関数のlist、を箇条書きでまとめ、md末尾に追記してください」

---

## 外部仕様の案
- ミッション成功後、すべてのボタンを一度離すまで次のミッションの入力受付を開始しない
- 連続で同じ/類似ミッションが出ても、前のボタン押しっぱなしではクリア判定されない

## 内部仕様の案
- ミッション成功直後、「全ボタン離し待ち」状態に遷移
- すべてのボタンが離されたことを検知したら、次のミッションの入力受付を開始
- 「全ボタン離し待ち」中は、どんな入力も無視する

## 変更のある関数のlist
- `main_loop`（`main.py`）: ゲームループに「全ボタン離し待ち」状態を追加
- `check_and_update_mission`（`missions.py`）: ミッション判定のタイミング制御
- 必要に応じて、ボタン状態取得・管理部分（`joystick.py` など）

# 壁打ち
- プロンプト「全ボタン離し待ち状態は良いですね。その状態であることをuserに示す必要がありそうですが、どうですか？検討結果を箇条書きしてください」

---

## 全ボタン離し待ち状態のユーザー通知に関する検討結果
- 全ボタン離し待ち状態をuserに明示するのは有用
    - 理由：次の入力が受け付けられない理由が直感的に分かるため、混乱やストレスを防げる
- 表示方法の案
    - 画面上に「全ボタンを離してください」等のメッセージを表示
    - ミッション表示部分の色や背景を変えて状態を示す
    - 一時的にスコア表示や入力欄をグレーアウトする
- 実装コストは低め（既存のラベルやUI更新処理に分岐を追加するだけで対応可能）
- メッセージの文言や表示方法は、ユーザビリティを考慮して調整するのが望ましい

# 壁打ち
- プロンプト「main_loop内はそのままで、check_and_update_mission 内に関数呼び出しを追加するイメージですが、どうですか？検討結果を箇条書きしてください」

---

## 検討結果

- `main_loop`の構造や流れを変更せず、既存の責務を維持できるため、影響範囲が限定される
- ミッション判定や状態遷移のロジックを`check_and_update_mission`に集約でき、可読性・保守性が向上する
- 「全ボタン離し待ち」状態の管理や、次ミッション受付開始のタイミング制御も`check_and_update_mission`内で完結できる
- 必要に応じて、UI更新やユーザー通知の関数も`check_and_update_mission`から呼び出せる
- 既存の`main_loop`の他処理（描画、入力取得など）との干渉リスクが低い
- 状態管理が複雑化しすぎないよう、状態遷移やフラグ管理の実装には注意が必要

---

一理ありますね。表示はupdate_display_with_missionが担当するよう、切り分けたいので、引数と戻り値に工夫が必要ですね。

---

## 検討結果

- `check_and_update_mission`の戻り値に「全ボタン離し待ち」状態（例: wait_for_all_release: bool）を追加する
- `update_display_with_mission`の引数に「全ボタン離し待ち」状態を追加し、UI表示を分岐させる
- これにより、ロジックとUIの責務分離が明確になり、保守性・拡張性が向上する
- 状態変数はタプルや辞書でまとめて返すと、引数・戻り値が煩雑になりにくい
- 既存の呼び出し箇所（main_loop）も、引数・戻り値の追加のみで対応可能

---

この方針で実装すれば、設計の意図が明確に保たれます。ご希望があれば、具体的なコード修正案もご提案できます。

# 思いつきを書く
- 具体的な状態遷移（`wait_for_all_release = True`）のトリガーは、`missions.py`の`on_green` がよさげ。読みやすそう。
- 同様に、`wait_for_all_release = False`のトリガーは、`missions.py`の`check_and_update_mission` の先頭がよさげ。これも読みやすそう。
    - そして、lock中は`check_and_update_mission`の先頭で`wait_for_all_release == True`なら早期returnする。
- 描画層は切り分けて別途実装が可能だと判断する。別issueに切り分けるのがよさげ。

# 壁打ち
- プロンプト「思いつきを書く欄をベースに検討し、検討結果を箇条書きしてください」

---

## 検討結果（全ボタン離し検知タイミングの明確化）

- ミッション成功時（on_green）で `wait_for_all_release = True` に遷移し、全ボタン離し待ち状態に入る
- `check_and_update_mission` の先頭で `wait_for_all_release == True` なら、まず全ボタンが離されているかをチェックする
    - 全ボタンが離されていれば `wait_for_all_release = False` に遷移し、次ミッションの受付を開始
    - まだ離されていなければ早期returnし、ロック状態を維持
- この判定により、「全ボタン離しを検知したタイミングで」次ミッション受付が始まる
- 状態遷移の責務が `missions.py` に集約され、可読性・保守性が向上する
- UI層は `wait_for_all_release` 状態を受けて分岐表示するだけでよく、ロジックとUIの分離が明確
- 既存のmain loopやUI更新処理への影響は最小限で済む
